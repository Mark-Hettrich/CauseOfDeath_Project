```{r Packages}
library(survival)
library(survminer)
library(dplyr)
library(readr)
library(here)
library(nnet)
library(ggplot2)
library(MASS)
library(flexsurv)
library(timereg)
library(mgcv)
library(cmprsk)
library(broom)
library(splines)
library(purrr)
library(pscl)
options(scipen = 999)
```

```{r  Loading Data & Adjusting}
file_path <- here("Datasets", "Population Data Merge", "Age Group Data", "All_Causes_Age_Groups10.csv")
df <- read.csv(file_path)
df <- df %>%
  filter(!(Ten.Year.Age.Groups %in% c("< 1 year", "1-4 years", "5-14 years", "15-24 years"))) %>%
  mutate(Cause = as.factor(Cause)) %>%
  mutate(adjusted_population = round(adjusted_population)) %>%
  mutate(Sex = as.factor(Sex)) %>%
  mutate(Education = as.factor(Education)) %>%
  mutate(Deaths = as.numeric(Deaths))

df$Education <- factor(df$Education, levels = c(
  "8th grade or less",
  "9th through 12th grade with no diploma",
  "High school graduate or GED completed",
  "Some college credit, but not a degree",
  "Associate degree (AA,AS)",
  "Bachelor’s degree (BA, AB, BS)",
  "Master’s degree (MA, MS, MEng, MEd, MSW, MBA)",
  "Doctorate (PhD, EdD) or Professional Degree (MD, DDS, DVM, LLB, JD)"
), ordered = FALSE)
df$Cause <- relevel(df$Cause, ref = "Others")

df_combined_sex <- df %>%
  group_by(`Ten.Year.Age.Groups`, Education, Cause) %>%
  summarise(
    Deaths = sum(Deaths, na.rm = TRUE),
    adjusted_population = sum(adjusted_population, na.rm = TRUE),
    .groups = "drop"
  )
```

```{r Deaths per Age Group & Education}
causes <- unique(df_combined_sex$Cause)

for (cause in causes) {
  p <- ggplot(subset(df_combined_sex, Cause == cause), aes(x = `Ten.Year.Age.Groups`, y = Deaths, color = Education)) +
    geom_point(alpha = 0.7, position = position_jitter(width = 0.2, height = 0)) +  # optional jitter
    labs(title = paste("Deaths by Age Group and Education –", cause),
         x = "Ten-Year Age Group",
         y = "Number of Deaths") +
    scale_color_brewer(palette = "Dark2") + 
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))  # rotate x-axis labels for readability
  
  print(p)
}
```
```{r log(Deaths) per Age Group & Education}
causes <- unique(df_combined_sex$Cause)

for (cause in causes) {
  p <- ggplot(subset(df_combined_sex, Cause == cause), aes(x = `Ten.Year.Age.Groups`, y = log(Deaths), color = Education)) +
    geom_point(alpha = 0.7, position = position_jitter(width = 0.2, height = 0)) +  # optional jitter
    labs(title = paste("Deaths by Age Group and Education –", cause),
         x = "Ten-Year Age Group",
         y = "log(Number of Deaths)") +
    scale_color_brewer(palette = "Dark2") + 
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))  # rotate x-axis labels for readability
  
  print(p)
}
```

```{r normalized}
causes <- unique(df_combined_sex$Cause)

for (cause in causes) {
  p <- ggplot(subset(df_combined_sex, Cause == cause), aes(x = `Ten.Year.Age.Groups`, y = Deaths/adjusted_population, color = Education)) +
    geom_point(alpha = 0.7, position = position_jitter(width = 0.2, height = 0)) +  # optional jitter
    labs(title = paste("Deaths by Age Group and Education –", cause),
         x = "Ten-Year Age Group",
         y = "Number of Deaths") +
    scale_color_brewer(palette = "Dark2") + 
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))  # rotate x-axis labels for readability
  
  print(p)
}
```

```{r normalized & log()}
causes <- unique(df_combined_sex$Cause)

for (cause in causes) {
  p <- ggplot(subset(df_combined_sex, Cause == cause), aes(x = `Ten.Year.Age.Groups`, y = log(Deaths/adjusted_population), color = Education)) +
    geom_point(alpha = 0.7, position = position_jitter(width = 0.2, height = 0)) +  # optional jitter
    labs(title = paste("Deaths by Age Group and Education –", cause),
         x = "Ten-Year Age Group",
         y = "Number of Deaths") +
    scale_color_brewer(palette = "Dark2") + 
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))  # rotate x-axis labels for readability
  
  print(p)
}
```

```{r Data All Deaths Model}
all_deaths <- df %>% filter(Cause == "All Deaths")
```

```{r Model for all Deaths}
nb_model <- glm.nb(Deaths ~ Ten.Year.Age.Groups + Sex + Education + offset(log(adjusted_population)),
                    data = all_deaths,
                  )
summary(nb_model)
exp(coefficients(nb_model))  

nb_model2 <- glm.nb(Deaths ~ Ten.Year.Age.Groups * Sex + Ten.Year.Age.Groups * Education + Sex * Education + offset(log(adjusted_population)),
                    data = all_deaths,
                  )
summary(nb_model2) #probably scale coefficients (exp(coef) = Deaths per person, so take them * 100k to get a deaths per 100k)
```

```{r Predicted vs Observed}
all_deaths$predicted <- predict(nb_model2, type = "response")
all_deaths$observed <- all_deaths$Deaths

ggplot(all_deaths, aes(x = predicted, y = observed)) +
  geom_point(alpha = 0.7) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "blue") +
  labs(
    title = "Observed vs Predicted Death Counts",
    x = "Predicted Deaths",
    y = "Observed Deaths"
  ) +
  theme_minimal()

ggplot(all_deaths, aes(x = predicted, y = observed, color = Sex)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  theme_minimal()

ggplot(all_deaths, aes(x = predicted, y = observed)) +
  geom_point(alpha = 0.6) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  facet_wrap(~Ten.Year.Age.Groups) +
  theme_minimal()

ggplot(all_deaths, aes(x = predicted, y = observed)) +
  geom_point(alpha = 0.6) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "blue") +
  facet_wrap(~Education) +
  labs(
    title = "Observed vs Predicted Deaths by Education Level",
    x = "Predicted Deaths",
    y = "Observed Deaths"
  ) +
  theme_minimal()
```

```{r Predicted vs normalized Observed}
# Add observed and predicted death rates per 100,000
all_deaths$observed <- all_deaths$Deaths / all_deaths$adjusted_population * 100000
all_deaths$predicted <- predict(nb_model2, type = "response") / all_deaths$adjusted_population * 100000

# 1. Observed vs Predicted (basic)
ggplot(all_deaths, aes(x = predicted, y = observed)) +
  geom_point(alpha = 0.7) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "blue") +
  labs(
    title = "Observed vs Predicted Death Rates (per 100,000)",
    x = "Predicted Rate",
    y = "Observed Rate"
  ) +
  theme_minimal()

# 2. Colored by Sex
ggplot(all_deaths, aes(x = predicted, y = observed, color = Sex)) +
  geom_point(alpha = 0.7) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  labs(
    title = "Observed vs Predicted Death Rates by Sex",
    x = "Predicted Rate",
    y = "Observed Rate"
  ) +
  theme_minimal()

# 3. Faceted by Age Group
ggplot(all_deaths, aes(x = predicted, y = observed)) +
  geom_point(alpha = 0.6) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  facet_wrap(~Ten.Year.Age.Groups) +
  labs(
    title = "Observed vs Predicted Death Rates by Age Group",
    x = "Predicted Rate",
    y = "Observed Rate"
  ) +
  theme_minimal()

# 4. Faceted by Education
ggplot(all_deaths, aes(x = predicted, y = observed)) +
  geom_point(alpha = 0.6) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "blue") +
  facet_wrap(~Education) +
  labs(
    title = "Observed vs Predicted Death Rates by Education Level",
    x = "Predicted Rate",
    y = "Observed Rate"
  ) +
  theme_minimal()
```

```{r}
others_data <- df %>% filter(Cause == "Others")

nb_others <- glm.nb(Deaths ~ Ten.Year.Age.Groups + Sex + Education +
                    offset(log(adjusted_population)), data = others_data)

nb_others_int <- glm.nb(Deaths ~ Ten.Year.Age.Groups * Sex +
                        Ten.Year.Age.Groups * Education +
                        Sex * Education +
                        offset(log(adjusted_population)), data = others_data)
accidents_data <- df %>% filter(Cause == "Accidents")

nb_accidents <- glm.nb(Deaths ~ Ten.Year.Age.Groups + Sex + Education +
                       offset(log(adjusted_population)), data = accidents_data)

nb_accidents_int <- glm.nb(Deaths ~ Ten.Year.Age.Groups * Sex +
                           Ten.Year.Age.Groups * Education +
                           Sex * Education +
                           offset(log(adjusted_population)), data = accidents_data)
stroke_data <- df %>% filter(Cause == "Cerebrovascular Diseases")

nb_stroke <- glm.nb(Deaths ~ Ten.Year.Age.Groups + Sex + Education +
                    offset(log(adjusted_population)), data = stroke_data)

nb_stroke_int <- glm.nb(Deaths ~ Ten.Year.Age.Groups * Sex +
                        Ten.Year.Age.Groups * Education +
                        Sex * Education +
                        offset(log(adjusted_population)), data = stroke_data)
covid_data <- df %>% filter(Cause == "COVID")

nb_covid <- glm.nb(Deaths ~ Ten.Year.Age.Groups + Sex + Education +
                   offset(log(adjusted_population)), data = covid_data)

nb_covid_int <- glm.nb(Deaths ~ Ten.Year.Age.Groups * Sex +
                       Ten.Year.Age.Groups * Education +
                       Sex * Education +
                       offset(log(adjusted_population)), data = covid_data)
heart_data <- df %>% filter(Cause == "Diseases of Heart")

nb_heart <- glm.nb(Deaths ~ Ten.Year.Age.Groups + Sex + Education +
                   offset(log(adjusted_population)), data = heart_data)

nb_heart_int <- glm.nb(Deaths ~ Ten.Year.Age.Groups * Sex +
                       Ten.Year.Age.Groups * Education +
                       Sex * Education +
                       offset(log(adjusted_population)), data = heart_data)
neoplasm_data <- df %>% filter(Cause == "Neoplasms")

nb_neoplasm <- glm.nb(Deaths ~ Ten.Year.Age.Groups + Sex + Education +
                      offset(log(adjusted_population)), data = neoplasm_data)

nb_neoplasm_int <- glm.nb(Deaths ~ Ten.Year.Age.Groups * Sex +
                          Ten.Year.Age.Groups * Education +
                          Sex * Education +
                          offset(log(adjusted_population)), data = neoplasm_data)
```

```{r}
# OTHERS
cat("======= OTHERS =======\n")
cat("AIC (Main effects): ", AIC(nb_others), "\n")
cat("AIC (Interaction):  ", AIC(nb_others_int), "\n\n")

# ACCIDENTS
cat("\n======= ACCIDENTS =======\n")
cat("AIC (Main effects): ", AIC(nb_accidents), "\n")
cat("AIC (Interaction):  ", AIC(nb_accidents_int), "\n\n")


# STROKE
cat("\n======= CEREBROVASCULAR DISEASES =======\n")
cat("AIC (Main effects): ", AIC(nb_stroke), "\n")
cat("AIC (Interaction):  ", AIC(nb_stroke_int), "\n\n")
summary(nb_stroke)
summary(nb_stroke_int)

# COVID
cat("\n======= COVID =======\n")
cat("AIC (Main effects): ", AIC(nb_covid), "\n")
cat("AIC (Interaction):  ", AIC(nb_covid_int), "\n\n")
summary(nb_covid)
summary(nb_covid_int)

# HEART
cat("\n======= DISEASES OF HEART =======\n")
cat("AIC (Main effects): ", AIC(nb_heart), "\n")
cat("AIC (Interaction):  ", AIC(nb_heart_int), "\n\n")
summary(nb_heart)
summary(nb_heart_int)

# NEOPLASMS
cat("\n======= NEOPLASMS =======\n")
cat("AIC (Main effects): ", AIC(nb_neoplasm), "\n")
cat("AIC (Interaction):  ", AIC(nb_neoplasm_int), "\n\n")
summary(nb_neoplasm)
summary(nb_neoplasm_int)

```

```{r}
cat("======= OTHERS =======\n")
summary(nb_others_int)

cat("\n======= ACCIDENTS =======\n")
summary(nb_accidents_int)

cat("\n======= CEREBROVASCULAR DISEASES =======\n")
summary(nb_stroke_int)

cat("\n======= COVID =======\n")
summary(nb_covid_int)

cat("\n======= DISEASES OF HEART =======\n")
summary(nb_heart_int)

cat("\n======= NEOPLASMS =======\n")
summary(nb_neoplasm_int)
```


