

#xii2??
#Difference of difference methods??
#anssamble model death ate -> causw // linea combination of pedictos
# for mark : is in suv analysis only "1" in deaths status?
# ARIMA  for seasons??



```{r}
library(ggplot2)
library(mgcv)
library(here)
library(nnet)
library(broom)
library(tidyr)

# Load data
file_path <- here("Population Data Merge", "All_Causes_Combined.csv")
All_Causes_Combined <- read_csv(file_path)

# Load data
file_path <- here("Population Data Merge", "cps_00006.csv")
cps_00006 <- read_csv(file_path)

All_Causes_Combined <- All_Causes_Combined[, c("Cause", "AGE", "Sex", "Education", "Deaths", "population")]

# Create a new column death_rate in the All_Causes_Combined dataset
All_Causes_Combined <- All_Causes_Combined %>%
  mutate(death_rate = Deaths / population) %>%
  mutate(death_rate_scale = death_rate * 1000)

# Convert variables to factors
model_data <- All_Causes_Combined %>% 
  mutate(Sex = as.factor(Sex), 
         Education = as.factor(Education), 
         Cause = as.factor(Cause))
```




#Multonimial 
# - efeence categoy?

```{r}


# Build multinomial model
multinom_model <- multinom(Cause ~ Sex + Education + AGE, data = model_data)

# Get formatted output using broom::tidy()
model_summary <- tidy(multinom_model)

# Print the formatted table
print(model_summary)
```










# Suvival Analysis


#poblem with scale
# Only Neoplasms
```{r}

library(dplyr)
library(dplyr)

# Example of filtering data for "Neoplasms"
model_data_c <- model_data %>%
  filter(!is.na(death_rate_scale) & !is.na(population) & Cause == "Neoplasms" & AGE > 0)

# Step 1: Create rows for death cases (status = 1)
expanded_deaths <- model_data_c %>%
  rowwise() %>%
  do(data.frame(cause = rep(.$Cause, .$death_rate_scale),  # repeat cause for the number of deaths
                status = rep(1, .$death_rate_scale),  # death status
                age = rep(.$AGE, .$death_rate_scale),  # repeat age
                sex = rep(.$Sex, .$death_rate_scale),  # repeat sex for each death case
                education = rep(.$Education, .$death_rate_scale)))  # repeat education for each death case

# Step 2: Create rows for remaining people (status = 0)
remaining_people <- model_data_c %>%
  rowwise() %>%
  do(data.frame(cause = rep(.$Cause, round(1000 - .$death_rate_scale)),  # repeat cause for the remaining people
                status = rep(0, round(1000 - .$death_rate_scale)),  # status for remaining people
                age = rep(.$AGE, round(1000 - .$death_rate_scale)),  # repeat age for the remaining people
                sex = rep(.$Sex, round(1000 - .$death_rate_scale)),  # repeat sex for the remaining people
                education = rep(.$Education, round(1000 - .$death_rate_scale))))  # repeat education for the remaining people

# Step 3: Combine both datasets
aft_data <- bind_rows(expanded_deaths, remaining_people)

# View the result
head(aft_data)




```

#Kaplan 
Kaplan-Meier Curve позволяет увидеть, как различные уровни образования влияют на вероятность выживания в зависимости от возраста. Результат даст нам кривые выживаемости для каждой группы по образованию.
```{r}
# Load packages
library(survival)
library(survminer)

# Create a Surv object for survival analysis
surv_object <- Surv(time = aft_data$age, event = aft_data$status)

# Fit the Kaplan-Meier curve
km_fit <- survfit(surv_object ~ education, data = aft_data)

# Visualize the Kaplan-Meier curve
ggsurvplot(km_fit, data = aft_data, pval = TRUE, 
           title = "Kaplan-Meier Curve for Education Groups",
           xlab = "Age", ylab = "Survival Probability",
           risk.table = TRUE, # Add risk table
           conf.int = TRUE)   # Add confidence interval


```
#Cox Proportional Hazards Model
Cox Proportional Hazards Model будет показывать, как каждый фактор (например, возраст, образование и причина смерти) влияет на риски смерти (или выживаемости) после учета других факторов. Для каждого уровня переменной education и других переменных модель даст коэффициенты (hazard ratios) и их статистическую значимость.
```{r}
# Build the Cox Proportional Hazards model
cox_model <- coxph(surv_object ~ education + sex, data = aft_data)

# Summary of the Cox model
summary(cox_model)
```

#Compare
```{r}
# library(mgcv)
# library(glmnet)
# # Step 2: Cox Proportional Hazards Model
# cox_model <- coxph(surv_object ~ sex + education, data = aft_data)
# 
# # Step 3: Generalized Additive Model (GAM)
# #gam_model <- coxph(surv_object ~ s(age) + sex + s(education), data = aft_data)
# 
# # Step 4: Penalized Model (Lasso)
# x <- as.matrix(aft_data[, c("age", "sex", "education")])
# y <- Surv(aft_data$age, aft_data$status)
# 
# # Lasso model (alpha = 1 for Lasso)
# lasso_model <- cv.glmnet(x, y, alpha = 1, family = "cox")
# 
# # Step 5: Model evaluation
# 
# # Log-Likelihood for Cox and GAM models
# cox_loglik <- logLik(cox_model)
# gam_loglik <- logLik(gam_model)
# 
# # AIC for Cox and GAM models
# cox_aic <- AIC(cox_model)
# gam_aic <- AIC(gam_model)
# 
# # C-index for Cox, GAM, and Lasso models
# cox_cindex <- concordance.index(cox_model)
# gam_cindex <- concordance.index(gam_model)
# 
# # For the Lasso model, C-index can be obtained through cv.glmnet
# lasso_cindex <- 1 - lasso_model$cvm[which.min(lasso_model$cvm)]
# 
# # Compare results
# comparison <- data.frame(
#   Model = c("Cox", "GAM", "Lasso"),
#   LogLik = c(cox_loglik, gam_loglik, NA),  # LogLik is not available for Lasso
#   AIC = c(cox_aic, gam_aic, NA),          # AIC is also not available for Lasso
#   Cindex = c(cox_cindex, gam_cindex, lasso_cindex)
# )
# 
# # Print results
# print(comparison)

```












# death ate

```{r}
# Пример линейной регрессии
lm_model <- lm(death_rate ~ AGE + Sex + Education, data = model_data)

# Результаты модели
summary(lm_model)
```
```{r}
library(lme4)
library(Matrix)
# Чистим данные
model_data_clean <- model_data %>%
  filter(!is.na(death_rate) & !is.na(AGE) & !is.na(Sex) & !is.na(Education))

# Преобразуем переменные
x <- model.matrix(death_rate ~ AGE + Sex + Education, data = model_data_clean)[,-1]  # Преобразуем в матрицу
y <- model_data_clean$death_rate

# 1. Линейная регрессия
lm_model <- lm(death_rate ~ AGE + Sex + Education, data = model_data_clean)
lm_aic <- AIC(lm_model)

# 2. Lasso регрессия
lasso_model <- cv.glmnet(x, y, alpha = 1)
lasso_preds <- predict(lasso_model, s = "lambda.min", newx = x)
lasso_residuals <- y - lasso_preds
lasso_num_params <- sum(lasso_model$glmnet.fit$beta != 0)  # Количество ненулевых коэффициентов
lasso_logLik <- -length(y) / 2 * log(sum(lasso_residuals^2) / length(y))  # Логарифм правдоподобия
lasso_aic <- -2 * lasso_logLik + 2 * lasso_num_params  # AIC

# 3. Ridge регрессия
ridge_model <- cv.glmnet(x, y, alpha = 0)
ridge_preds <- predict(ridge_model, s = "lambda.min", newx = x)
ridge_residuals <- y - ridge_preds
ridge_num_params <- sum(ridge_model$glmnet.fit$beta != 0)
ridge_logLik <- -length(y) / 2 * log(sum(ridge_residuals^2) / length(y))
ridge_aic <- -2 * ridge_logLik + 2 * ridge_num_params


# 6. Модель с случайными эффектами
mixed_model <- lmer(death_rate ~ AGE + Sex + (1 | Education), data = model_data_clean)
mixed_aic <- AIC(mixed_model)

# Сравнение моделей по AIC
comparison <- data.frame(
  Model = c("Linear Regression", "Lasso", "Ridge", "Mixed Effects"),
  AIC = c(lm_aic, lasso_aic, ridge_aic, mixed_aic)
)

# Печать результатов
print(comparison)

```

