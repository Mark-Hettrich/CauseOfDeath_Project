---
title: "Untitled"
author: "Xinyu Meng"
date: "2025-03-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
```{r}
library(haven)
library(dplyr)
library(tidyverse)
library(stats)
library(cluster)
library(factoextra)
library(dynamicTreeCut)
library(fastDummies)
library(lubridate)
library(ggplot2)
theme_set(theme_minimal())

df.15.causes <- read.csv("covid-19 cause of death.csv", na.strings = c("", "NA"))

df.covid19 <- read.csv("covid-19 cause of death.csv")

df_clean <- df.15.causes %>%
  drop_na(Deaths, Crude.Rate)

```


```{r}
df_encoded <- dummy_cols(df_clean, select_columns = "Cause.of.death", remove_first_dummy = TRUE)

#Calculate Pearson and Spearman correlation coefficients
cor_pearson_cause <- cor(df_encoded[, -c(1:3)], df_encoded$Deaths, use = "complete.obs", method = "pearson")
cor_spearman_cause <- cor(df_encoded[, -c(1:3)], df_encoded$Deaths, use = "complete.obs", method = "spearman")

cat("Pearson Correlation Coefficient of Death Count vs. Disease Type:\n")
print(cor_pearson_cause)
cat("\n")

cat("Spearman Correlation Coefficient of Death Count vs. Disease Type:\n")
print(cor_spearman_cause)
cat("\n")

#Disease Type vs. Death Count (Bar Chart)
top_causes <- df_clean %>%
  filter(!is.na(Cause.of.death)) %>%
  group_by(Cause.of.death) %>%
  summarise(Total_Deaths = sum(Deaths, na.rm = TRUE)) %>%
  arrange(desc(Total_Deaths)) %>%
  head(5)

ggplot(top_causes, aes(x = reorder(Cause.of.death, Total_Deaths), y = Total_Deaths)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +
  labs(title = "Death Count vs. Disease Type (Top 5 Diseases)",
       x = "Cause of Death",
       y = "Total Death") +
  theme_minimal()

```


```{r}
#Rank by crude rate and filter the top 10
top_10 <- df.15.causes %>%
  filter(!is.na(Cause.of.death)) %>%
  arrange(desc(Crude.Rate)) %>%
  head(5)

#Plot a bar chart of the top 10 diseases by crude rate
ggplot(top_10, aes(x = reorder(Cause.of.death, Crude.Rate), y = Crude.Rate)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(
    title = "Top 10 Diseases by Crude Mortality Rate",
    x = "Cause of Death",
    y = "Crude Rate (per 1000 population)"
  ) +
  theme_minimal()

```

```{r cars}
df_clean <- df.15.causes %>%
  mutate(
    Crude.Rate = ifelse(is.na(Crude.Rate), 0, Crude.Rate),
    is_covid = ifelse(Cause.of.death.Code == "U07.1", "COVID-19", "Other")
  )

covid_vs_other <- df_clean %>%
  filter(!is.na(Cause.of.death)) %>%
  group_by(is_covid) %>%
  summarise(Total.Deaths = sum(Deaths, na.rm = TRUE))

#Plot a pie chart
ggplot(covid_vs_other, aes(x = "", y = Total.Deaths, fill = is_covid)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y", start = 0) +
  labs(
    title = "Proportion of Deaths: COVID-19 vs. Other Causes",
    fill = "Category"
  ) +
  theme_void()

#Wilcoxon Test (Non-Parametric Test)
wilcox.test(Deaths ~ is_covid, data = df_clean)
```

```{r cars}
#Filter out diabetes data (ICD-10 codes E10-E14)
diabetes_data <- df_clean %>%
  filter(grepl("E1[0-4]", Cause.of.death.Code))

#Group by diabetes type (ICD-10 codes), calculate death count and average death rate
diabetes_summary <- diabetes_data %>%
  group_by(Cause.of.death.Code) %>%
  summarise(
    Mean.Crude.Rate = mean(Crude.Rate, na.rm = TRUE),
    Total.Deaths = sum(Deaths, na.rm = TRUE)
  ) %>%
  drop_na(Mean.Crude.Rate, Total.Deaths) %>%
  filter(Total.Deaths > 0 & Mean.Crude.Rate > 0)

max_deaths <- max(diabetes_summary$Total.Deaths, na.rm = TRUE)
max_rate <- max(diabetes_summary$Mean.Crude.Rate, na.rm = TRUE)

#Plot a grouped bar chart (ICD-10 codes as the x-axis)
ggplot(diabetes_summary, aes(x = reorder(Cause.of.death.Code, -Total.Deaths))) +
  geom_bar(aes(y = Total.Deaths, fill = "Total Deaths"), stat = "identity", width = 0.6) +
  geom_line(aes(y = Mean.Crude.Rate * max_deaths / max_rate, group = 1, color = "Mean Crude Rate"), size = 1) +
  geom_point(aes(y = Mean.Crude.Rate * max_deaths / max_rate, color = "Mean Crude Rate"), size = 3) +
  scale_y_continuous(
    name = "Total Deaths",
    sec.axis = sec_axis(~ . * max_rate / max_deaths, name = "Mean Crude Rate")
  ) +
  labs(
    title = "Diabetes Type (ICD-10) vs. Death Count & Average Death Rate",
    x = "Diabetes Type (ICD-10)"
  ) +
  scale_fill_manual(values = c("Total Deaths" = "steelblue")) +
  scale_color_manual(values = c("Mean Crude Rate" = "red")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
