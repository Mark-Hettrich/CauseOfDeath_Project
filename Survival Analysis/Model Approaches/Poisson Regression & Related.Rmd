```{r Packages}
library(survival)
library(survminer)
library(dplyr)
library(readr)
library(here)
library(nnet)
library(ggplot2)
library(MASS)
library(flexsurv)
library(timereg)
library(mgcv)
library(cmprsk)
library(broom)
library(splines)
library(purrr)
library(pscl)
options(scipen = 999)
```

Missing Population will lead to skewed results
```{r load Data & prep}
df <- Top_5_Death

df <- df %>%
  mutate(
    age = as.numeric(`Single-Year Ages Code`),                        
    Sex = factor(Sex),
    CoD = factor(`Cause of Death`),
    urb = factor(Urbanization)
  )
#zero Inflated Data?
ggplot(df, aes(x = Deaths)) +
  geom_histogram(binwidth = 1, fill = "skyblue", color = "black") +
  scale_x_continuous(breaks = 0:max(df$Deaths)) +
  labs(title = "Histogram of Death Counts",
       x = "Deaths",
       y = "Frequency") +
  theme_minimal()
#yes, data is Zero Inflated
```
```{r Poisson regression & Dispersion Calculation}
poisson_model <- glm(Deaths ~ age + Urbanization + Sex+  CoD,
                     data = df,
                     family = poisson(link = "log"))

summary(poisson_model)

# Calculate dispersion
dispersion <- sum(residuals(poisson_model, type = "pearson")^2) / poisson_model$df.residual
dispersion #should be 1 --> significant overdispersion

```
Negative Binomial Model
```{r}
nb_model <- glm.nb(Deaths ~ age + Sex + CoD + Urbanization, data = df)
summary(nb_model)
```
Zero Inflated Negative Binomial
```{r}
zinb_model <- zeroinfl(Deaths ~ age + Sex + CoD + Urbanization, link = "logit", dist = "negbin", data = df)
summary(zinb_model)
```

Split up by Death Causes
```{r}

```

Residual PLots
```{r}
# --- Fit ZINB Model ---
zinb_model <- zeroinfl(Deaths ~ age + Sex + CoD + Urbanization | 1,
                       data = df,
                       dist = "negbin",
                       link = "logit")

# --- Extract model data and outputs ---
model_data <- zinb_model$model  # Only the rows used by the model
model_results <- data.frame(
  row_id = as.numeric(rownames(model_data)),
  predicted = predict(zinb_model, type = "response"),
  resid = residuals(zinb_model, type = "pearson")
)

# --- Add a row_id to original df ---
df$row_id <- as.numeric(rownames(df))

# --- Merge model results back to full data safely ---
df_with_results <- left_join(df, model_results, by = "row_id")

# --- Plot: Predicted vs Observed ---
plot(df_with_results$predicted, df_with_results$Deaths,
     xlab = "Predicted Deaths", ylab = "Observed Deaths",
     main = "Predicted vs. Observed Deaths")
abline(0, 1, col = "red")

# --- QQ Plot of Pearson Residuals ---
qqnorm(df_with_results$resid, main = "QQ Plot of Pearson Residuals")
qqline(df_with_results$resid)

# --- Standardized Residuals ---
df_with_results$std_resid <- df_with_results$resid / sqrt(df_with_results$predicted)

# --- Plot: Standardized Residuals ---
plot(df_with_results$std_resid,
     main = "Standardized Pearson Residuals",
     ylab = "Standardized Residuals", xlab = "Observation Index")
abline(h = 0, col = "red", lty = 2)

# --- Plot: Residuals by Sex ---
ggplot(df_with_results, aes(x = row_id, y = resid, color = Sex)) +
  geom_point(alpha = 0.5, size = 0.3) +
  theme_minimal() +
  labs(title = "Residuals by Sex", x = "Observation", y = "Pearson Residual")

# --- Plot: Residuals by Cause of Death ---
ggplot(df_with_results, aes(x = row_id, y = resid, color = CoD)) +
  geom_point(alpha = 0.5, size = 0.3) +
  theme_minimal() +
  labs(title = "Residuals by Cause of Death", x = "Observation", y = "Pearson Residual")

# --- Histogram of Residuals ---
hist(df_with_results$resid, breaks = 50,
     main = "Histogram of Pearson Residuals", xlab = "Residual")

```
To Do:
- readjust Models by adding interactions & stratification & splines
- model by CoD individually
- Readjust residuals
